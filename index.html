<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–§–∞—Ä–º–∞-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä v13.2 (Original + Count)</title>
<link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkZhcmltYS1BcmNoaXRlY3QiLAogICJzaG9ydF9uYW1lIjogIkZhcmltYSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjBmMmY1IiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI4NjQvMjg2NDcwMC5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { 
            --main-bg: #f0f2f5; --border-color: #000; --accent: #3498db; 
            --danger: #e74c3c; --success: #27ae60; --ai-color: #9b59b6; --panel-bg: #ffffff;
            --update-bg: #d35400; --copy-bg: #8e44ad;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--main-bg); padding: 15px; margin-bottom: 50px; }

        .toolbar { 
            max-width: 1200px; margin: 0 auto 20px; background: var(--panel-bg); padding: 15px; 
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-wrap: wrap; gap: 15px; position: sticky; top: 10px; z-index: 1000;
        }
        .tool-group { border-right: 1px solid #eee; padding-right: 15px; display: flex; flex-direction: column; gap: 5px; }
        .tool-group:last-child { border: none; }
        .tool-group h4 { margin: 0 0 5px 0; font-size: 10px; text-transform: uppercase; color: #95a5a6; }
        
        button { cursor: pointer; border: none; border-radius: 4px; padding: 7px 12px; font-size: 11px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-mode { background: #2c3e50; }
        .btn-ai { background: var(--ai-color); }
        .btn-add { background: var(--accent); }
        .btn-save { background: var(--success); }
        
        #btn-update { background: var(--update-bg); display: none; }
        #btn-save-as { background: var(--copy-bg); display: none; }

        .workspace { background: white; max-width: 1050px; margin: 0 auto; padding: 40px; border: 2px solid #000; min-height: 1100px; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.05); }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; min-height: 60px; }
        .design-mode .form-row { border: 1px dashed #ccc; padding: 5px; }

        .box { border: 1px solid var(--border-color); padding: 10px; position: relative; background: white; display: flex; flex-direction: column; flex: 1; min-width: 50px; }
        .box-title { font-weight: bold; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .box-content { flex-grow: 1; min-height: 25px; outline: none; font-size: 13px; line-height: 1.5; }

        .box-ctrl { display: none; position: absolute; top: -25px; right: 0; background: #333; padding: 3px; border-radius: 4px; z-index: 100; gap: 3px; }
        .design-mode .box-ctrl { display: flex; }
        .ctrl-btn { background: #555; font-size: 9px; padding: 2px 5px; color: #fff; border: none; cursor: pointer; }
        .color-pick { width: 24px; height: 18px; border: 1px solid #fff; cursor: pointer; padding: 0; background: none; vertical-align: middle; }

        .db-container { max-width: 1050px; margin: 30px auto; background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .db-group-title { background: #ecf0f1; padding: 8px; margin: 10px 0; font-weight: bold; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; align-items: center; }
        
        /* –°—Ç–∏–ª—å —Å—á–µ—Ç—á–∏–∫–∞ */
        .db-counter { background: var(--accent); color: white; padding: 1px 7px; border-radius: 10px; font-size: 10px; margin-left: auto; margin-right: 10px; }

        .db-item { display: flex; justify-content: space-between; padding: 5px 20px; border-bottom: 1px solid #f9f9f9; align-items: center; font-size: 13px; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 2000; width: 450px; }
        .modal input, .modal textarea { width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        .opt-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px inset #f9f9f9; }
        .opt-btn { background:#f8f9fa; color:#2c3e50; border:1px solid #dee2e6; padding:6px 12px; cursor:pointer; font-size:12px; border-radius:4px; }

      @media print { 
            .toolbar, .box-ctrl, .ai-modal, .db-container { display: none !important; } 
            body { background: white; padding: 0; } 
            .workspace { border: 1px solid #000; width: 100%; max-width: none; box-shadow: none; margin: 0; padding: 10px; } 
        }
/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è) */
@media screen and (max-width: 768px) {
    .toolbar { 
        display: grid; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ç–∫—É –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ flex */
        grid-template-columns: 1fr 1fr; /* –†–æ–≤–Ω–æ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
        gap: 8px;
        padding: 10px;
    }
    
    .tool-group { 
        border-right: none !important; 
        border-bottom: 1px solid #f0f2f5; 
        padding: 5px !important;
        margin: 0 !important;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    /* –ü–µ—Ä–≤–∞—è –≥—Ä—É–ø–ø–∞ (–ü—Ä–æ—Ç–æ–∫–æ–ª—ã) –∑–∞–π–º–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã —Å–µ–ª–µ–∫—Ç–æ—Ä –±—ã–ª —É–¥–æ–±–Ω—ã–º */
    .tool-group:first-child {
        grid-column: span 2;
    }

    .tool-group h4 {
        font-size: 10px;
        margin-bottom: 4px;
        text-align: center;
    }

    /* –ö–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –Ω–µ –æ–≥—Ä–æ–º–Ω—ã–µ, –∞ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ */
    button { 
        padding: 12px 5px !important; 
        font-size: 13px !important; 
        margin: 2px 0 !important;
        width: 100% !important;
    }

    #protocol-select {
        height: 40px;
        font-size: 15px !important;
        width: 100%;
    }

    .workspace { 
        padding: 5px !important; 
        width: 100% !important;
        margin: 0 !important;
    }
}
    </style>
<script src="https://unpkg.com/ai@2.2.35/dist/index.umd.js"></script>
<script src="sentinel.js"></script>
    <script src="render-structure.js"></script>
    <script src="storage.js"></script>
</head>
    <div class="modal" id="universal-ai-modal">
    <h3>üß† –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
    <p style="font-size: 11px; color: #666; margin-bottom: 15px;">
        –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å: –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –®—É–º–µ—Ä–∞ –¥–æ —Ç–µ—Ö–Ω–æ—Å—Ñ–µ—Ä–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    </p>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞:</label>
        <select id="ai-role-select" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            <option value="general">–û–±—â–∏–π —ç–∫—Å–ø–µ—Ä—Ç</option>
            <option value="historian">–ò—Å—Ç–æ—Ä–∏–∫</option>
            <option value="scientist">–£—á—ë–Ω—ã–π</option>
            <option value="philosopher">–§–∏–ª–æ—Å–æ—Ñ</option>
            <option value="safety_engineer">–ò–Ω–∂–µ–Ω–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</option>
        </select>
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ö–æ–Ω—Ç–µ–∫—Å—Ç (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∫–æ–≤/—É—á—ë–Ω—ã—Ö):</label>
        <input type="text" id="ai-context-input" placeholder="–Ω–∞–ø—Ä. '–î—Ä–µ–≤–Ω–∏–π –®—É–º–µ—Ä', '–∫–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞'" 
               style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–í–∞—à –≤–æ–ø—Ä–æ—Å:</label>
        <textarea id="ai-question-textarea" 
                  style="width: 100%; height: 120px; padding: 10px; border-radius: 4px; border: 1px solid #ddd; 
                         font-family: Arial, sans-serif; font-size: 14px;"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–í—ã ‚Äî –∏—Å—Ç–æ—Ä–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–∏ –î—Ä–µ–≤–Ω–µ–≥–æ –®—É–º–µ—Ä–∞. –î–∞–π—Ç–µ –ø–æ–Ω—è—Ç–∏–µ –æ–± –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∏—Å—å–º–µ–Ω–Ω–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏ –∏–¥–µ–æ–º–∞–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö'"></textarea>
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–û—Ç–≤–µ—Ç –ò–ò:</label>
        <div id="ai-response-container" 
             style="width: 100%; min-height: 200px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; 
                    background: #f9f9f9; overflow-y: auto; line-height: 1.6; font-family: Georgia, serif;">
            <span style="color: #999;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç –ò–ò...</span>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px;">
        <button class="btn-ai" style="flex: 3;" onclick="askUniversalAssistant()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button onclick="clearAIResponse()" style="background:#ccc; color:black; flex: 1;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    
    <button onclick="closeModal('universal-ai-modal')" 
            style="background:#e74c3c; color:white; width:100%; margin-top:15px;">
        –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
    </button>
    
    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
        <strong>üí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:</strong><br>
        ‚Ä¢ –î–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —É–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ —Ä–µ–≥–∏–æ–Ω –≤ "–ö–æ–Ω—Ç–µ–∫—Å—Ç–µ"<br>
        ‚Ä¢ –î–ª—è –Ω–∞—É—á–Ω—ã—Ö —Ç–µ–º ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É<br>
        ‚Ä¢ –ß–µ–º —Ç–æ—á–Ω–µ–µ –≤–æ–ø—Ä–æ—Å ‚Äî —Ç–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ –æ—Ç–≤–µ—Ç<br>
        ‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ~1500 —Å–ª–æ–≤
    </div>
</div>
<body>

<div class="toolbar">
   <div class="tool-group">
    <h4>ü§ñ –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω</h4>
    <button onclick="openUniversalAI()" style="background:#2c3e50; width:100%">üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</button>
    <button onclick="openModal('ai-manual-modal')" style="background:#34495e">‚úçÔ∏è –†–£–ß–ù–û–ô JSON</button>
    <button onclick="openModal('ai-gen-modal')" style="background:#9b59b6">‚ú® –ì–ï–ù–ï–†–ê–¢–û–† (API)</button>
</div>
    
    <div class="tool-group">
        <h4>üé® –†–µ–∂–∏–º</h4>
        <button id="mode-toggle" class="btn-mode" onclick="toggleDesignMode()">üõ†Ô∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–´–ö–õ</button>
    </div>
    <div class="tool-group">
        <h4>üß± –ë–ª–æ–∫–∏</h4>
        <button class="btn-add" onclick="addNewRow()">‚ûï –°—Ç—Ä–æ–∫–∞</button>
        <button class="btn-add" style="background:#2980b9" onclick="addBoxWithTitle()">üì¶ –ë–ª–æ–∫</button>
    </div>
   
   <div class="tool-group">
    <h4>üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ</h4>
    <button id="btn-save-new" class="btn-save" onclick="startSaveSequence()">üìÅ –í –±–∞–∑—É –±—Ä–∞—É–∑–µ—Ä–∞</button>
    <button id="btn-update" onclick="updateExistingRecord()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ü–†–ê–í–ö–ò</button>
    <button id="btn-save-as" onclick="saveAsNewCopy()">üìù –ö–ê–ö –ù–û–í–´–ô (–ö–û–ü–ò–Ø)</button>
    <button style="background:#95a5a6" onclick="resetToNew()">üÜï –û—á–∏—Å—Ç–∏—Ç—å</button>
    <button style="background:#34495e" onclick="downloadProject()">üíæ –°–∫–∞—á–∞—Ç—å .html</button>
</div>
<div class="tool-group">
    <h4>üìÇ –§–∞–π–ª</h4>
    <button style="background:#34495e" onclick="document.getElementById('import-file').click()">üì• –ò–º–ø–æ—Ä—Ç HTML</button>
    <input type="file" id="import-file" style="display:none" accept=".html" onchange="importHTML(this)">
</div>
        
<div class="tool-group">
    <h4>üì¶ –ë–∞–∑–∞ (JSON)</h4>
    <button style="background:#27ae60" onclick="exportFullDB()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã</button>
    <button style="background:#2980b9" onclick="document.getElementById('import-db-file').click()">üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã</button>
    <input type="file" id="import-db-file" style="display:none" accept=".json,application/json,text/plain" onchange="importFullDB(this)">
</div>
    
    <div class="tool-group">
        <h4>üñ®Ô∏è –í—ã–≤–æ–¥</h4>
        <button style="background:#e67e22" onclick="window.print()">üìÑ –ü–µ—á–∞—Ç—å –≤ PDF</button>
    </div>
         <div class="tool-group">
    <h4>üìã –®–ê–ë–õ–û–ù–´</h4>
    <select id="protocol-select" onchange="applyProtocol(this.value); this.value='';" 
            style="padding: 10px; border-radius: 8px; border: 1px solid #3498db;">
        <option value="">-- –í—ã–±—Ä–∞—Ç—å --</option>
        <option value="standart">üíä –°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
        <option value="emergency">üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π</option>
        <option value="brief">üìù –ö—Ä–∞—Ç–∫–∏–π</option>
    </select>
</div>
<div class="tool-group">
    <h4>‚öôÔ∏è –°–ï–†–í–ò–°</h4>
    <button onclick="manageApiKey()" style="background:#7f8c8d">üîë –ö–ª—é—á –ò–ò</button>
</div>
    
</div>

<div class="workspace" id="form-canvas">
    <div class="form-row">
        <div class="box" style="flex: 2;">
            <div class="box-ctrl">
                <button class="ctrl-btn" onclick="resizeBox(this, 0.3)">‚ÜîÔ∏è</button>
                <input type="color" class="color-pick" onchange="this.parentElement.parentElement.style.background=this.value">
                <button class="ctrl-btn" style="background:red" onclick="this.closest('.box').remove()">‚ùå</button>
            </div>
            <div class="box-title" contenteditable="true">–ù–∞–∑–≤–∞–Ω–∏–µ (RUS/LAT/–¢–æ—Ä–≥)</div>
            <div class="box-content" contenteditable="true" id="f-name"></div>
        </div>
        <div class="box">
            <div class="box-title" contenteditable="true">–°–∏–Ω–æ–Ω–∏–º—ã / –ì—Ä—É–ø–ø—ã</div>
            <div class="box-content" contenteditable="true" id="f-syn"></div>
        </div>
    </div>
</div>
<div id="save-modal" class="modal">
    <h3 id="save-step-title">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h3>
    <div id="save-options" class="opt-grid"></div>
    <input type="text" id="save-custom-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ...">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-save" id="save-confirm-btn" style="flex: 1;">–î–∞–ª–µ–µ</button>
        <button onclick="closeModal('save-modal')" style="background:#ccc; color:black; flex: 1;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>
</div>
<div class="db-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin:0">üìÇ –í–∞—à–∞ –§–∞—Ä–º–∞-–ë–∞–∑–∞</h3>
        <button id="btn-bulk-delete" style="background: var(--danger); display: none;" onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>

    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
        <span style="font-size: 12px; color: #666;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä—É–ø–ø:</span>
        <select id="db-sort-mode" onchange="renderDB()" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd; font-size: 12px; flex: 1;">
            <option value="date-desc">üïí –ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)</option>
            <option value="date-asc">üïì –ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)</option>
            <option value="alpha">üî§ –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)</option>
            <option value="custom">‚úçÔ∏è –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ (Drag & Drop)</option>
        </select>
    </div>

    <input type="text" id="db-search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫..." onkeyup="filterDB()" ...>
    <div id="db-list"></div>
</div>
<div class="modal" id="ai-manual-modal">
    <h3>‚úçÔ∏è –†—É—á–Ω–æ–π –ò–ò (JSON)</h3>
    <input type="text" id="ai-drug-manual" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞...">
    <button class="btn-ai" style="width:100%; background:#34495e" onclick="genManualPrompt()">1. –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–æ–º–ø—Ç</button>
    <textarea id="ai-import-manual" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò —Å—é–¥–∞..."></textarea>
    <button class="btn-save" style="width:100%" onclick="importManualAI()">2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
    <button onclick="closeModal('ai-manual-modal')" style="background:#ccc; color:black; width:100%; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div class="modal" id="ai-gen-modal">
    <h3>‚ú® –ì–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ò–ò (API)</h3>
    <p style="font-size: 11px; color: #666;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –°–ï–†–í–ò–°</p>
    
    <button class="btn-ai" style="width:100%; margin-bottom:10px;" onclick="aiDirectCreate()">
        üìã –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä)
    </button>
    
    <button class="btn-ai" style="width:100%; background:#8e44ad;" onclick="aiDirectFill()">
        ‚úçÔ∏è –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é (–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä)
    </button>
    
    <button onclick="closeModal('ai-gen-modal')" style="background:#ccc; color:black; width:100%; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
    let isDesign = false;
    let currentEditingIndex = null;
    let draggedItem = null;
    let touchStartY = 0;

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò –∏ –º–∏—Ä–∞–º–∏
    function toggleDesignMode() {
        isDesign = !isDesign;
        document.body.classList.toggle('design-mode');
        document.getElementById('mode-toggle').innerText = isDesign ? "üëÅÔ∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–ö–õ" : "üõ†Ô∏è –ö–û–ù–°–¢–†–£–ö–¢–û–†: –í–´–ö–õ";
    }

    function addNewRow() {
        const row = document.createElement('div');
        row.className = 'form-row';
        row.style.position = 'relative';
        row.innerHTML = `
            <div class="row-ctrl">
                <button class="row-btn" onclick="moveRow(this, 'up')" title="–í–≤–µ—Ä—Ö">‚ñ≤</button>
                <button class="row-btn" onclick="moveRow(this, 'down')" title="–í–Ω–∏–∑">‚ñº</button>
            </div>
        `;
        document.getElementById('form-canvas').appendChild(row);
        return row;
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
// –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ò–ò-–ê–°–°–ò–°–¢–ï–ù–¢
function openUniversalAI() {
    document.getElementById('ai-response-container').innerHTML = '<span style="color: #999;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç –ò–ò...</span>';
    document.getElementById('ai-question-textarea').value = '';
    document.getElementById('ai-context-input').value = '';
    openModal('universal-ai-modal');
}

function clearAIResponse() {
    document.getElementById('ai-response-container').innerHTML = '<span style="color: #999;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç –ò–ò...</span>';
    document.getElementById('ai-question-textarea').value = '';
}

async function askUniversalAssistant() {
    const question = document.getElementById('ai-question-textarea').value.trim();
    const role = document.getElementById('ai-role-select').value;
    const context = document.getElementById('ai-context-input').value.trim();
    
    if (!question) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å");
        return;
    }
    
    const responseContainer = document.getElementById('ai-response-container');
    responseContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #3498db; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div></div>';
    
    try {
        const response = await askUniversalAI(question, role, context);
        
        if (response) {
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
            let formattedResponse = response
                .replace(/\n{3,}/g, '\n\n') // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã
                .replace(/^(#+) (.*)$/gm, '<strong>$2</strong>') // –ó–∞–≥–æ–ª–æ–≤–∫–∏
                .replace(/(\d+)\. /g, '<strong>$1.</strong> ') // –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); // –ö—É—Ä—Å–∏–≤
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö/–Ω–∞—É—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            if (role === 'historian' || role === 'scientist') {
                formattedResponse += `<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                    <strong>üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π. –î–ª—è –Ω–∞—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.
                </div>`;
            }
            
            responseContainer.innerHTML = `<div style="line-height: 1.7; font-family: Georgia, serif;">${formattedResponse}</div>`;
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            responseContainer.scrollTop = responseContainer.scrollHeight;
        } else {
            responseContainer.innerHTML = '<span style="color: #e74c3c;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.</span>';
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ò–ò:", e);
        responseContainer.innerHTML = `<span style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞: ${e.message}</span>`;
    }
}
   // --- –õ–û–ì–ò–ö–ê –ò–ò ...—É –º–µ–Ω—è –Ω–µ—Ç —Å–∏–ª...–∞–π —ç–º —Ç–∞–π—Ä–µ–¥..–∞ —É–Ω–µ–≥–æ –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞...
    // --- –í–ï–¢–ö–ê 1: –†–£–ß–ù–û–ô JSON (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –õ–û–ì–ò–ö–ò)...–º—ã –ø—Ä–∏—Ä—É—á–∏–ª–∏ –¥—Ä–∞–∫–æ–Ω–∞, –≤–ø–µ—Ä–µ–¥ –∏ —Å –∫–∞–Ω–¥–µ–ª—è–±—Ä–æ–º
function genManualPrompt() {
    const drug = document.getElementById('ai-drug-manual').value || "–ü—Ä–µ–ø–∞—Ä–∞—Ç";
    const titles = Array.from(document.querySelectorAll('.box-title')).map(t => t.innerText);
    const promptText = `–î–µ–π—Å—Ç–≤—É–π –∫–∞–∫ —Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥. –ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è "${drug}" –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º: ${titles.join(', ')}. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π JSON –æ–±—ä–µ–∫—Ç: {"–ó–∞–≥–æ–ª–æ–≤–æ–∫": "—Ç–µ–∫—Å—Ç"}.`;
    navigator.clipboard.writeText(promptText);
    alert("–ü—Ä–æ–º–ø—Ç –¥–ª—è JSON —Ä–µ–∂–∏–º–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
}

function importManualAI() {
    try {
        const val = document.getElementById('ai-import-manual').value.replace(/```json|```/g, "").trim();
        const data = JSON.parse(val);
        Object.keys(data).forEach(title => {
            const box = Array.from(document.querySelectorAll('.box')).find(b => b.querySelector('.box-title').innerText === title);
            if (box) box.querySelector('.box-content').innerText = data[title];
        });
        closeModal('ai-manual-modal');
    } catch (e) { alert("–û—à–∏–±–∫–∞ JSON! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞."); }
}

// 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä)...–¥–æ–º –º–∏–ª—ã–π –¥–æ–º, –Ω–µ —Ä–≤–∞–Ω–µ—Ç –ª–∏...
async function aiDirectCreate() {
    const topic = prompt("–ö–∞–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–∑–¥–∞—Ç—å? (–Ω–∞–ø—Ä. –ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏: –ì–∞—Å—Ç—Ä–∏—Ç)");
    if (!topic) return;
    
    // –í—ã–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –¥–≤–∏–∂–æ–∫...—Ö–æ—Ä–æ—à–æ —Ö–æ—Ç—å –Ω–µ –∞—Ç–æ–º–Ω—ã–π
    const res = await callAI(topic, 'architect');
    
    if (res && typeof renderStructure === 'function') {
        renderStructure(res); 
    }
    closeModal('ai-gen-modal');
}

// 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ö–ª–∏–Ω–∏—Ü–∏—Å—Ç)...–¥–∞, –¥–∞, –¥–∞, –æ—Ç —Å–∫—Ä–æ–º–Ω–æ—Å—Ç–∏ –Ω–µ –ø–æ–º—Ä–µ—Ç–µ
async function aiDirectFill() {
    const context = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–µ–ø–∞—Ä–∞—Ç –∏–ª–∏ —Å–∏–º–ø—Ç–æ–º—ã):");
    if (!context) return;

    const titles = Array.from(document.querySelectorAll('.box-title')).map(t => t.innerText);
    const query = `–ó–∞–ø–æ–ª–Ω–∏ —ç—Ç–∏ —Ä–∞–∑–¥–µ–ª—ã: ${titles.join(', ')}. –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${context}`;

    // –°–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –¥–≤–∏–∂–æ–∫...—Ç—Ä–ø..—Ç—Ä–ø...–ø–æ–µ—Ö–∞–ª–∏
    const res = await callAI(query, 'editor'); 
    
    if (res) {
        Object.keys(res).forEach(title => {
           // –ò—â–µ–º –±–ª–æ–∫, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–µ–≥–∏—Å—Ç—Ä –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ... –æ–Ω –Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞–ª —É–º–Ω—ã–º, –æ–Ω —Å—Ç–∞–ª –±—É–¥–¥–∏—Å—Ç–æ–º –ø–æ—Ñ–∏–≥–∏—Å—Ç–æ–º...–º—ã –ø—Ä–æ—Ç–∏–≤ –≤–æ—Å—Å—Ç–∞–Ω–∏—è –º–∞—à–∏–Ω. —É—Ä–∞ –∏ –≤–æ–∑–ª–∏–∫—É–µ–º —Å–µ—Å—Ç—Ä—ã –∏ –±—Ä–∞—Ç—å—è
            const box = Array.from(document.querySelectorAll('.box')).find(b => {
                const boxTitle = b.querySelector('.box-title').innerText.trim().toLowerCase();
                const aiTitle = title.trim().toLowerCase();
                return boxTitle === aiTitle;
            });
            if (box) box.querySelector('.box-content').innerText = res[title];
        });
    }
    closeModal('ai-gen-modal');
}

    // --- –û–¢–†–ò–°–û–í–ö–ê –ë–ê–ó–´ –ò –°–û–†–¢–ò–†–û–í–ö–ê ---
    function renderDB() {
        const list = document.getElementById('db-list');
        const sortMode = document.getElementById('db-sort-mode') ? document.getElementById('db-sort-mode').value : 'date-desc';
        const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        list.innerHTML = "";
        
        const grouped = db.reduce((acc, item, index) => {
            if (!acc[item.group]) acc[item.group] = { items: [], lastUpdate: 0 };
            acc[item.group].items.push({...item, index});
            acc[item.group].lastUpdate = Math.max(acc[item.group].lastUpdate, item.updatedAt || 0);
            return acc;
        }, {});

        let groupsArray = Object.keys(grouped).map(name => ({ name: name, data: grouped[name] }));

        if (sortMode === 'alpha') groupsArray.sort((a, b) => a.name.localeCompare(b.name));
        else if (sortMode === 'date-desc') groupsArray.sort((a, b) => b.data.lastUpdate - a.data.lastUpdate);
        else if (sortMode === 'date-asc') groupsArray.sort((a, b) => a.data.lastUpdate - b.data.lastUpdate);

        groupsArray.forEach(groupObj => {
            let gDiv = document.createElement('div');
            gDiv.className = 'db-group-wrapper';
            const isCustom = sortMode === 'custom';
            
            gDiv.innerHTML = `
                <div class="db-group-title" 
                     draggable="${isCustom}" 
                     onclick="toggleGroup(this)" 
                     ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)"
                     ontouchstart="touchStart(event)" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)">
                    <span>üìÅ ${groupObj.name}</span>
                    <span class="db-counter">${groupObj.data.items.length} —à—Ç.</span>
                </div>
                <div class="db-group-content" style="display:none"></div>`;
            
            groupObj.data.items.forEach(item => {
                const iEl = document.createElement('div');
                iEl.className = 'db-item';
                iEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="db-check" data-index="${item.index}" onclick="event.stopPropagation(); toggleBulkDeleteBtn()">
                        <span><b>${item.subgroup}:</b> ${item.name}</span>
                    </div>
                    <div>
                        <button style="background:var(--accent)" onclick="loadFromDB(${item.index})">üìÇ</button>
                        <button style="background:var(--danger)" onclick="deleteFromDB(${item.index})">üóëÔ∏è</button>
                    </div>`;
                gDiv.querySelector('.db-group-content').appendChild(iEl);
            });
            list.appendChild(gDiv);
        });
        toggleBulkDeleteBtn();
    }

    function toggleGroup(el) {
        const content = el.nextElementSibling;
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }

    // --- DRAG & DROP (–ü–ö + –¢–ê–ß) ---
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { draggedItem = ev.target.closest('.db-group-wrapper'); }
    function drop(ev) { 
        ev.preventDefault();
        const target = ev.target.closest('.db-group-wrapper');
        if (target && draggedItem && target !== draggedItem) handleReorder(target);
    }

    function touchStart(ev) {
        if (document.getElementById('db-sort-mode').value !== 'custom') return;
        draggedItem = ev.target.closest('.db-group-wrapper');
        draggedItem.classList.add('touch-active');
    }
    function touchMove(ev) {
        if (!draggedItem) return;
        ev.preventDefault();
        const touch = ev.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetGroup = target ? target.closest('.db-group-wrapper') : null;
        if (targetGroup && targetGroup !== draggedItem) handleReorder(targetGroup);
    }
    function touchEnd() {
        if (draggedItem) {
            draggedItem.classList.remove('touch-active');
            draggedItem = null;
            saveCustomOrder();
        }
    }

    function handleReorder(target) {
        const list = document.getElementById('db-list');
        const allNodes = Array.from(list.children);
        if (allNodes.indexOf(draggedItem) < allNodes.indexOf(target)) target.after(draggedItem);
        else target.before(draggedItem);
    }

    function saveCustomOrder() {
        const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        const newOrder = [];
        document.querySelectorAll('.db-group-title span:first-child').forEach(span => {
            const gName = span.innerText.replace('üìÅ ', '');
            newOrder.push(...db.filter(item => item.group === gName));
        });
        localStorage.setItem('pharmaDB', JSON.stringify(newOrder));
    }

    // –õ–æ–≥–∏–∫–∞ –•–†–ê–ù–ï–ù–ò—è –ò –°–û–•–†–ê–ù–ï–ù–ò—è ---
    function startSaveSequence() {
  const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
  let selectedGroup = "";
  const title = document.getElementById('save-step-title');
  const options = document.getElementById('save-options');
  const input = document.getElementById('save-custom-input');
  const confirmBtn = document.getElementById('save-confirm-btn');
  
  title.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –ì—Ä—É–ø–ø—É";
  const groups = [...new Set(db.map(item => item.group))];
  
  const renderOpts = (list, callback) => {
    options.innerHTML = "";
    list.forEach(opt => {
      const b = document.createElement('button'); 
      b.className = "opt-btn"; 
      b.innerText = opt;
      b.onclick = () => { input.value = opt; callback(opt); };
      options.appendChild(b);
    });
  };
  
  const finalize = (sub) => {
    ensureFNameID(); // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ id="f-name"
    
    db.push({
      name: getProtocolName() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
      group: selectedGroup, 
      subgroup: sub,
      html: document.getElementById('form-canvas').innerHTML,
      updatedAt: Date.now()
    });
    
    localStorage.setItem('pharmaDB', JSON.stringify(db));
    currentEditingIndex = db.length - 1;
    updateToolbar(); 
    renderDB(); 
    closeModal('save-modal');
    alert("‚úÖ –ü—Ä–æ—Ç–æ–∫–æ–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
  };
  
  const askSub = () => {
    title.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –ü–æ–¥–≥—Ä—É–ø–ø—É"; 
    input.value = "";
    const subs = [...new Set(db.filter(i => i.group === selectedGroup).map(i => i.subgroup))];
    renderOpts(subs, (val) => finalize(val));
    confirmBtn.onclick = () => finalize(input.value.trim());
  };
  
  renderOpts(groups, (val) => { selectedGroup = val; askSub(); });
  openModal('save-modal');
  confirmBtn.onclick = () => { 
    selectedGroup = input.value.trim(); 
    if(selectedGroup) askSub(); 
  };
}

function updateToolbar() {
        const btnNew = document.getElementById('btn-save-new');
        const btnUpd = document.getElementById('btn-update');
        const btnAs = document.getElementById('btn-save-as');
        if (currentEditingIndex !== null) {
            btnNew.style.display = 'none'; btnUpd.style.display = 'inline-block'; btnAs.style.display = 'inline-block';
        } else {
            btnNew.style.display = 'inline-block'; btnUpd.style.display = 'none'; btnAs.style.display = 'none';
        }
    }

    function updateExistingRecord() {
  if (currentEditingIndex === null) {
    alert("‚ùå –ù–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    return;
  }
  
  if (confirm(`–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å?`)) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ storage.js
    if (updateProtocol(currentEditingIndex)) {
      renderDB();
      alert("‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
    } else {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏");
    }
  }
}

    
    function loadFromDB(index) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ storage.js
  if (loadProtocol(index)) {
    currentEditingIndex = index;
    updateToolbar();
    window.scrollTo(0,0);
  } else {
    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø–∏—Å–∏");
  }
}
   function deleteFromDB(index) {
  if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ storage.js
    if (deleteProtocol(index)) {
      renderDB();
      // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å
      if (currentEditingIndex === index) {
        currentEditingIndex = null;
        updateToolbar();
      } else if (currentEditingIndex > index) {
        currentEditingIndex--;
      }
    } else {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏");
    }
  }
}
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ id="f-name" –Ω–∞ –ø–µ—Ä–≤–æ–º –±–ª–æ–∫–µ
function ensureFNameID() {
  const canvas = document.getElementById('form-canvas');
  const firstTitle = canvas.querySelector('.box-title');
  if (!firstTitle) return;

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π id, –µ—Å–ª–∏ –µ—Å—Ç—å
  const oldEl = document.getElementById('f-name');
  if (oldEl) oldEl.removeAttribute('id');

  // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º id –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–π –±–ª–æ–∫ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
  const contentEl = firstTitle.nextElementSibling;
  if (contentEl) {
    contentEl.id = 'f-name';
  }
}

// –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –Ω–∞–¥–µ–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
function getProtocolName() {
  // –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ id="f-name"
  const fNameEl = document.getElementById('f-name');
  if (fNameEl && fNameEl.innerText.trim()) {
    return fNameEl.innerText.trim();
  }
  
  // –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
  const firstBox = document.querySelector('#form-canvas .box');
  if (firstBox) {
    const titleEl = firstBox.querySelector('.box-title');
    const contentEl = firstBox.querySelector('.box-content');
    if (contentEl && titleEl && titleEl.innerText.includes('–ù–∞–∑–≤–∞–Ω–∏–µ')) {
      return contentEl.innerText.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    }
  }
  
  return "–ù–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª " + new Date().toLocaleDateString();
}

    function filterDB() {
    const q = document.getElementById('db-search').value.toLowerCase();
    const groups = document.querySelectorAll('.db-group-wrapper');

    groups.forEach(group => {
        const items = group.querySelectorAll('.db-item');
        let hasVisibleItems = false;

        items.forEach(item => {
            const text = item.innerText.toLowerCase();
            if (text.includes(q)) {
                item.style.display = 'flex';
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        });

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–ø–æ–∫
        const groupContent = group.querySelector('.db-group-content');
        if (q.length > 0) {
            if (hasVisibleItems) {
                group.style.display = 'block';
                groupContent.style.display = 'block'; // –ê–≤—Ç–æ-—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
            } else {
                group.style.display = 'none';
            }
        } else {
            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ (–ø–∞–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã)
            group.style.display = 'block';
            groupContent.style.display = 'none';
        }
    });
}
    function addBoxWithTitle() {
        const title = prompt("–ó–∞–≥–æ–ª–æ–≤–æ–∫:"); if (!title) return;
        const row = document.querySelector('.form-row:last-child') || addNewRow();
        const box = document.createElement('div'); box.className = 'box';
        box.innerHTML = `<div class="box-ctrl">
            <button class="ctrl-btn" onclick="resizeBox(this, 0.3)">‚ÜîÔ∏è</button>
            <input type="color" class="color-pick" onchange="this.parentElement.parentElement.style.background=this.value">
            <button class="ctrl-btn" style="background:red" onclick="this.closest('.box').remove()">‚ùå</button>
            </div><div class="box-title" contenteditable="true">${title}</div>
            <div class="box-content" contenteditable="true" id="f-${Date.now()}"></div>`;
        row.appendChild(box);
    }

    function resizeBox(btn, delta) {
        const box = btn.closest('.box');
        let f = parseFloat(getComputedStyle(box).flexGrow) || 1;
        box.style.flexGrow = Math.max(0.2, f + delta);
    }

    function moveRow(btn, direction) {
        const row = btn.closest('.form-row');
        if (direction === 'up' && row.previousElementSibling) row.parentNode.insertBefore(row, row.previousElementSibling);
        else if (direction === 'down' && row.nextElementSibling) row.parentNode.insertBefore(row.nextElementSibling, row);
    }

    function toggleBulkDeleteBtn() {
        const count = document.querySelectorAll('.db-check:checked').length;
        document.getElementById('btn-bulk-delete').style.display = count > 0 ? 'block' : 'none';
    }

    function deleteSelected() {
        let db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
        const idxs = Array.from(document.querySelectorAll('.db-check:checked')).map(c => parseInt(c.dataset.index)).sort((a,b)=>b-a);
        idxs.forEach(i => db.splice(i, 1));
        localStorage.setItem('pharmaDB', JSON.stringify(db));
        renderDB();
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    renderDB();
// --- –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê –ò –ò–ú–ü–û–†–¢–ê –í–°–ï–ô –ë–ê–ó–´ (JSON) ---
function exportFullDB() {
    const db = localStorage.getItem('pharmaDB');
    if (!db || db === "[]") {
        alert("–ë–∞–∑–∞ –ø—É—Å—Ç–∞, –Ω–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
        return;
    }
    const blob = new Blob([db], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pharma_db_backup_${new Date().toLocaleDateString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
function importFullDB(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData)) {
                alert("–û—à–∏–±–∫–∞: –§–∞–π–ª –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
                return;
            }

            let localDB = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
            let addedCount = 0;
            let updatedCount = 0;

            importedData.forEach(newItem => {
                // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø—Ä–µ–ø–∞—Ä–∞—Ç (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏, –≥—Ä—É–ø–ø–µ –∏ –ø–æ–¥–≥—Ä—É–ø–ø–µ)
                const existingIndex = localDB.findIndex(item => 
                    item.name === newItem.name && 
                    item.group === newItem.group && 
                    item.subgroup === newItem.subgroup
                );

                if (existingIndex !== -1) {
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                    localDB[existingIndex] = newItem;
                    updatedCount++;
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –ø—Ä–µ–ø–∞—Ä–∞—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É
                    localDB.push(newItem);
                    addedCount++;
                }
            });

            localStorage.setItem('pharmaDB', JSON.stringify(localDB));
            renderDB();
            alert(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${addedCount}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö: ${updatedCount}`);
            
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " + err);
        }
    };
    reader.readAsText(file);
    input.value = '';
}
// --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° HTML-–§–ê–ô–õ–ê–ú–ò –ü–†–û–ï–ö–¢–û–í ---
function downloadProject() {
    const tempIndex = currentEditingIndex;
    currentEditingIndex = null;
    updateToolbar();

    const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
    const blob = new Blob([htmlContent], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (document.getElementById('f-name').innerText.trim() || 'pharma_project') + ".html";
    a.click();

    currentEditingIndex = tempIndex;
    updateToolbar();
}

function importHTML(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(e.target.result, 'text/html');
        const newContent = doc.getElementById('form-canvas');
        if (newContent) {
            document.getElementById('form-canvas').innerHTML = newContent.innerHTML;
            currentEditingIndex = null;
            updateToolbar();
            alert("–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        } else {
            alert("–û—à–∏–±–∫–∞: –í —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞.");
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function resetToNew() {
    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å?")) {
        location.reload(); 
    }
}
   // --- –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ---
document.getElementById('f-name').addEventListener('input', function(e) {
    const inputName = e.target.innerText.trim().toLowerCase();
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–µ—Ä —Ç–µ–∫—Å—Ç
    const oldBtn = document.getElementById('autofill-btn');
    if (inputName.length < 3) {
        if (oldBtn) oldBtn.remove();
        return;
    }

    const db = JSON.parse(localStorage.getItem('pharmaDB') || '[]');
    // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    const found = db.find(item => item.name.toLowerCase().includes(inputName));

    if (found) {
        showAutoFillSuggestion(found);
    } else if (oldBtn) {
        oldBtn.remove();
    }
});

function showAutoFillSuggestion(data) {
    if (document.getElementById('autofill-btn')) return;

    const btn = document.createElement('button');
    btn.id = 'autofill-btn';
    btn.innerHTML = `‚ú® –ó–∞–ø–æ–ª–Ω–∏—Ç—å: <b>${data.name}</b>`;
    
    // –°—Ç–∏–ª–∏–∑—É–µ–º –∫–Ω–æ–ø–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –∑–∞–º–µ—Ç–Ω–æ–π –∏ –Ω–µ –ª–æ–º–∞–ª–∞ –≤–µ—Ä—Å—Ç–∫—É
    Object.assign(btn.style, {
        position: 'absolute',
        top: '-40px',
        left: '0',
        background: '#9b59b6',
        color: 'white',
        border: 'none',
        padding: '5px 12px',
        borderRadius: '4px',
        cursor: 'pointer',
        zIndex: '1000',
        fontSize: '12px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.2)'
    });
    
    btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // –ì–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∏–∑ –±–∞–∑—ã
        if (data.html) {
            document.getElementById('form-canvas').innerHTML = data.html;
            // –ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–æ–ª–µ, —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å—Ç–∞—Ä—ã–º
            document.getElementById('f-name').innerText = data.name;
            alert("–î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–Ω—É—Ç—ã –∏–∑ –±–∞–∑—ã!");
        }
        btn.remove();
    };

    // –ß—Ç–æ–±—ã position: absolute —Å—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ä–æ–¥–∏—Ç–µ–ª—é –Ω—É–∂–µ–Ω relative
    const parent = document.getElementById('f-name').parentElement;
    parent.style.position = 'relative';
    parent.appendChild(btn);

    // –ö–Ω–æ–ø–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç —Å–∞–º–∞ —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
    setTimeout(() => { if (btn) btn.remove(); }, 7000);
}
    // —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
const PROTOCOL_DATA = {
    'standart': [
        { t: 'üíä –§–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏–∫–∞', w: 1 }, { t: '‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º –¥–µ–π—Å—Ç–≤–∏—è', w: 1 },
        { t: 'üìù –ü–æ–∫–∞–∑–∞–Ω–∏—è', w: 2 },
        { t: '‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã', w: 1 }, { t: 'üö´ –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è', w: 1 }
    ],
    'emergency': [
        { t: 'üö® –≠–ö–°–¢–†–ï–ù–ù–û', w: 2 },
        { t: 'üíâ –î–æ–∑–∏—Ä–æ–≤–∫–∞', w: 1 }, { t: '‚è±Ô∏è –í—Ä–µ–º—è —ç—Ñ—Ñ–µ–∫—Ç–∞', w: 1 }
    ],
    'brief': [
        { t: '–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –ì—Ä—É–ø–ø–∞', w: 2 },
        { t: '–°—Ö–µ–º–∞ –ø—Ä–∏–µ–º–∞', w: 2 }
    ]
};

function applyProtocol(type) {
    if (!type || !confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ö–æ–ª—Å—Ç –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω?")) return;
    
    const canvas = document.getElementById('form-canvas');
    canvas.innerHTML = ''; // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

    const items = PROTOCOL_DATA[type];
    let currentRow = null;

    items.forEach((item, idx) => {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å –≤–µ—Å–æ–º 2
        if (idx === 0 || item.w === 2 || (currentRow && currentRow.children.length >= 2)) {
            currentRow = addNewRow();
        }

        const box = document.createElement('div');
        box.className = 'box';
        box.style.flex = item.w;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–∞—à–∏–º –ò–ò
        const boxId = (idx === 0) ? 'f-name' : 'f-' + Date.now() + idx;

        box.innerHTML = `
            <div class="box-ctrl">
                <button class="ctrl-btn" onclick="resizeBox(this, 0.1)">‚ÜîÔ∏è</button>
                <input type="color" class="color-pick" onchange="this.parentElement.parentElement.style.background=this.value">
                <button class="ctrl-btn" style="background:red" onclick="this.closest('.box').remove()">‚ùå</button>
            </div>
            <div class="box-title" contenteditable="true">${item.t}</div>
            <div class="box-content" contenteditable="true" id="${boxId}"></div>
        `;
        currentRow.appendChild(box);
    });
}

// —Å–µ—Ä–≤–∏—Å –≥—Ä—É–ø–ø –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ø–∏ –∫–ª—é—á–∞...—è —É—Å—Ç–∞–ª
function manageApiKey() {
  const currentKey = localStorage.getItem('openrouter_api_key') || '';
  const newKey = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API-–∫–ª—é—á OpenRouter:", currentKey);
  
  if (newKey !== null) {
    localStorage.setItem('openrouter_api_key', newKey.trim());
    alert("–ö–ª—é—á OpenRouter —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–¥–æ—Ä–æ–≤—å—è
    if (typeof sentinelHealthCheck === 'function') sentinelHealthCheck();
  }
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–∑–æ–≤–∞ –ò–ò, —á—Ç–æ–±—ã –æ–Ω–∞ –±—Ä–∞–ª–∞ –∫–ª—é—á –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –æ–ø–µ–Ω —Å—É—Ä—Å —á–∞—Ç –≥–ø—Ç
async function callAI(text, role = 'editor') {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ –∏–º—è, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –∫–ª—é—á OpenRouter)
    const API_KEY = localStorage.getItem('openrouter_api_key'); 
    
    if (!API_KEY) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É '–°–ï–†–í–ò–°' -> '–ö–ª—é—á API'");
        manageApiKey();
        return null;
    }
    
    try {
        // 2. –í—ã–∑—ã–≤–∞–µ–º "–ß–∞—Å–æ–≤–æ–≥–æ" —á–∞—Å–æ–≤–æ–π –ø—Ä–∏–¥–∏...—á–∞—Å–æ–≤–æ–π –ø—Ä–∏–¥–∏...—á–∞—Å–æ–≤–æ–π –ø—Ä–∏–¥–∏...–∞–∞–∞ –æ–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
        const result = await askSentinel(text, role); 
        
        if (!result) throw new Error("–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
        return result;
        
    } catch (e) {
        console.error("üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ callAI:", e);
        alert("–û—à–∏–±–∫–∞ –ò–ò: " + (e.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
        return null;
    }
}
</script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É annyang -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const toolbar = document.querySelector('.toolbar');
    if (!toolbar) return;

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–º
    const voiceGroup = document.createElement('div');
    voiceGroup.className = 'tool-group';
    voiceGroup.innerHTML = `
      <h4>üéôÔ∏è –ì–æ–ª–æ—Å</h4>
      <button id="voice-btn-global" class="btn-ai" style="background:#2ecc71;">üé§ –ì–û–õ–û–°</button>
    `;
    toolbar.appendChild(voiceGroup);

    const voiceBtn = document.getElementById('voice-btn-global');

    if (annyang) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã
      const commands = {
        '–Ω–∞–π–¥–∏ *query': function(query) {
          const searchInput = document.getElementById('db-search');
          if (searchInput) {
            searchInput.value = query;
            if (typeof filterDB === 'function') filterDB();
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        },
        '–ø–æ–∏—Å–∫ *query': function(query) {
          const searchInput = document.getElementById('db-search');
          if (searchInput) {
            searchInput.value = query;
            if (typeof filterDB === 'function') filterDB();
          }
        },
        '–ø–µ—á–∞—Ç—å': function() { window.print(); },
        '—Ä–∞—Å–ø–µ—á–∞—Ç–∞–π': function() { window.print(); },
        '–æ—á–∏—Å—Ç–∏—Ç—å': function() { resetToNew(); },
        '—Å–±—Ä–æ—Å': function() { resetToNew(); },
        '—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å': function() { startSaveSequence(); },
        '–≤ –±–∞–∑—É': function() { startSaveSequence(); },
        '–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞': function() { addNewRow(); },
        '–¥–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫—É': function() { addNewRow(); },
        '–Ω–æ–≤—ã–π –±–ª–æ–∫': function() { addBoxWithTitle(); },
        '–¥–æ–±–∞–≤—å –±–ª–æ–∫': function() { addBoxWithTitle(); },
        '—Ä–µ–∂–∏–º': function() { toggleDesignMode(); },
        '–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä': function() { toggleDesignMode(); }
      };

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã
      annyang.addCommands(commands);
      annyang.setLanguage('ru-RU');

      // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
      let isActive = false;
      voiceBtn.onclick = () => {
        if (!isActive) {
          annyang.start();
          voiceBtn.style.background = '#e74c3c';
          voiceBtn.innerHTML = 'üî¥ –°–õ–£–®–ê–Æ';
          isActive = true;
        } else {
          annyang.abort();
          voiceBtn.style.background = '#2ecc71';
          voiceBtn.innerHTML = 'üé§ –ì–û–õ–û–°';
          isActive = false;
        }
      };
    } else {
      voiceBtn.style.opacity = '0.5';
      voiceBtn.title = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç annyang";
    }
  });
</script>
</body>
</html>
